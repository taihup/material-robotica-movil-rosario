\documentclass[tp]{lcc}

% add latex preamble
\input{../../common/latex_preamble}

% add math preamble
\input{../../common/math_preamble}

\codigo{R-521}
\materia{Robótica Móvil}
\titulo{Graph SLAM}

% Mostrar soluciones
%\soluciones
%\commentstrue


\usepackage{biblatex}
%\addbibresource{refs.bib}

\begin{document}
\maketitle


\section{Introducción}
El objetivo de este trabajo práctico es implementar un solucionador de Pose Graph SLAM utilizando la librería GTSAM. En particular, se le pedirá que implemente tanto una solución batch como una solución incremental para los problemas SLAM 2D y 3D utilizando conjuntos de datos estándar.\footnote{Esta tarea se basa en Homework 7 -- SLAM of the NA 568 Mobile Robotics: Methods \& Algorithms -- Winter 2022 created by Maani Ghaffari -- University of Michigan}

\section*{Entrega}
	\begin{itemize}
        \item Se debe proveer un repositorio git que contenga el código desarrollado y un archivo \lstinline{README.md} con las instrucciones de compilación y ejecución. Se recomienda hacer una imagen Docker para facilitar la reproducción de los resultados.

        \item Se debe entregar un informe en Lyx o \LaTeX\  explicando el trabajo realizado y analizando los resultados obtenidos.
	\end{itemize}

\section*{Evaluación}
	\begin{itemize}
        \item Haciendo únicamente los ejercicios obligarorios (no opcionales), el trabajo tiene una nota máxima de 8. Los ejercicios opcionales permiten llegar a la nota máxima de 10.

        \item Entregas Fuera de Término: Si la entrega se realiza durante la primer semana luego del plazo, se decuentan 2 puntos. Si la entrega es más tarde que esto último la nota máxima es de 6.
	\end{itemize}

\section*{Pose Graph SLAM usando la librería GTSAM}
%
En este trabajo práctico, resolverá el problema SLAM con Pose-Graph utilizando la librería GTSAM. Si no está familiarizado con GTSAM, encontrará un tutorial detallado en su sitio web: \url{https://gtsam.org/tutorials/intro.html}. Para instalar GTSAM en C++, deberá clonar el código del repositorio: \url{https://github.com/borglab/gtsam}, descargar (usando git) la última versión y compilar la librería siguiendo las instrucciones.

Después de instalar GTSAM con éxito, escriba una función para leer archivos G2O \footnote{\url{https://github.com/RainerKuemmerle/g2o/wiki/File-Format}} y resuelva el problema de optimización de grafos para casos 2D y 3D usando GTSAM. En esta tarea, utilizamos los datos proporcionados en \url{https://lucacarlone.mit.edu/datasets/}.

Si bien GTSAM está desarrollado en C++, también proporciona un wrapper tanto para MATLAB como para Python. En esta tarea, es libre de utilizar cualquiera de esos lenguajes.

\subsection*{Guía de instalación de GTSAM}
A continuación proporcionamos una guía de instalación para las bibliotecas GTSAM, luego presentamos sus versiones C++, MATLAB y Python respectivamente.

\subsubsection*{Librería GTSAM}
El primer paso es clonar e instalar la librería GTSAM. Las instrucciones detalladas se pueden encontrar en el repositorio.

\textbf{Remark 1.} \textit{Si planea utilizar el wrapper de MATLAB o de Python, puede omitir esta parte.}

\textbf{Remark 2.} \textit{GTSAM requiere la librería Eigen. Se puede descargar e instalar desde aquí: \url{https://libeigen.gitlab.io/}}

\textbf{Remark 3.} \textit{Por favor, tenga en cuenta los requisitos previos: Boost >= 1.58 (Ubuntu: sudo apt-get install libboost-all-dev); CMake >= 3.0 (Ubuntu: sudo apt-get install cmake); Un compilador moderno, es decir, al menos gcc 4.7.3 en Linux.}

\begin{itemize}
    \item Clonar el repositorio de gtsam \url{https://github.com/borglab/gtsam}
    
    \lstinline[style=bash]{cd <path_to_your_repository>}
    
    \item Crear un nuevo directorio llamado ``build'':
    
    \lstinline[style=bash]{mkdir build}
    
    \item Navegar al directorio de compilación:
    
    \lstinline[style=bash]{cd build}

    \item Ejecutar cmake para crear enlaces esenciales para los archivos de compilación (\textbf{Nota}: si desea utilizar el wrapper de python, deberá hacer algo diferente aquí. Por favor, salte a la sección del wrapper de python)

    \lstinline[style=bash]{cmake ..}
\end{itemize}

\textbf{Remark 4.} \textit{Si recibe un error que indica que no se encuentra Boost, puede intentar instalarlo manualmente siguiendo \href{https://www.boost.org/doc/libs/1_66_0/more/getting_started/unix-variants.html\#get-boost}{este tutorial} y asegúrese de que está apuntando al directorio correcto agregando los siguientes comandos en CMakeList.txt:}

\begin{lstlisting}[style=bash]
SET (BOOST_ROOT "<your_boost_path>")
SET (BOOST_INCLUDEDIR "<your_boost_path>/boost")
SET (BOOST_LIBRARYDIR "<your_boost_path>/libs")
SET (BOOST_MIN_VERSION "1.58.0")
set (Boost_NO_BOOST_CHAKE ON)
\end{lstlisting}

\begin{itemize}
    \item Crea el archivo en el directorio de compilación (El comando -j10 indica el número de hilos que se usarán durante la compilación. Esto acelerará el proceso. Se recomienda usar el número máximo de núcleos menos 2, de lo contrario, tu máquina podría bloquearse. Si tiene 12 hilos en su máquina, use -j10). \lstinline[style=bash]{make -j10}
    \item Instalar la librería GTSAM en tu máquina. \lstinline[style=bash]{sudo make install -j10}
    \item En este paso, podrás ver la ruta donde se están instalando todos los paquetes. Si más tarde no puedes vincular la ruta de instalación a tu código, puedes volver a este paso y ver dónde se instaló.
\end{itemize}

\subsubsection*{C++}
Si desea utilizar C++, no necesita instalar nada más. Todo lo que necesita hacer es buscar y vincular la librería GTSAM agregando el siguiente contexto a su archivo CMakeList.txt.

\begin{lstlisting}[style=cmake]
find_package(GTSAM_REQUIRED)
include_directories(${GTSAM_INCLUDE_DIR})
target_link_libraries(<your_project> <your_project_lib> gtsam)
\end{lstlisting}

Puede consultar algunos ejemplos de GTSAM en C++ \url{https://github.com/borglab/gtsam/tree/develop/examples}.

\subsubsection*{Wrapper de MATLAB}
Si tiene un sistema Ubuntu más reciente (posterior a la versión 10.04), deberá realizar una pequeña modificación en su instalación de MATLAB, ya que MATLAB se distribuye con una versión antigua de la biblioteca estándar de C++. Elimine o cambie el nombre de todos los archivos que comiencen con libstdc++ en el directorio de instalación de MATLAB, en las siguientes rutas:

\begin{itemize}
    \item \lstinline[style=bash]|/usr/local/MATLAB/{version}/sys/os/{system}|
    \item \lstinline[style=bash]|/usr/local/MATLAB/{version}/bin/{system}|
\end{itemize}

Para el wrapper de MATLAB, se puede hacer de dos maneras:

\begin{enumerate}
    \item download the precompiled wrapper from \url{http://www.borg.cc.gatech.edu/download.html},
    \item or install from sources following the instructions in \url{https://github.com/borglab/gtsam/tree/develop/matlab}.
\end{enumerate}

Recomendamos usar el wrapper precompilado si no está familiarizado con los sistemas Linux. A continuación encontrará instrucciones sobre cómo agregar el wrapper de MATLAB precompilado a su conjunto de herramientas.

\begin{itemize}
    \item Descargar el wrapper precompilado. Descargar el toolbox de MATLAB precompilado (compatible con MATLAB R2011a y versiones posteriores) según su sistema operativo (Mac OS de 64 bits / Linux de 64 bits / Windows de 64 bits).
    \item Extraer la carpeta. (\textbf{Nota: para sistemas linux}, después de la extracción, deberá hacer clic derecho en el archivo extraído $\rightarrow$ Open With $\rightarrow$ Archive Mounter. Luego verá un \lstinline[style=bash]{gtsam-toolbox-3.2.0-lin64} en el lado izquierdo junto con Computadora, OS... La carpeta dentro llamada \lstinline[style=bash]{gtsam_toolbox} es la carpeta que queremos usar.)
    \item Colocar la carpeta \lstinline[style=bash]{gtsam_toolbox} en \lstinline[style=bash]{<YOUR_MATLAB_INSTALL_PATH>/toolbox/}
    \item Cada vez que abra su MATLAB, en el lado izquierdo de su GUI, navegue hasta su \lstinline[style=bash]{gtsam_toolbox} $\rightarrow$ clic derecho $\rightarrow$ add to path $\rightarrow$ selected folder. Luego debería poder ejecutar los códigos de ejemplo en la carpeta de ejemplos. O puede agregar los siguientes comandos al inicio del código.
    \begin{lstlisting}[style=bash]
addpath('<your_gtsam_toolbox_path>')
import gtsam.*
    \end{lstlisting}
\end{itemize}

Puede consultar algunos ejemplos de GTSAM en MATLAB en el directorio \lstinline[style=bash]{gtsam_toolbox/gtsam_examples}.

\subsubsection*{Wrapper de Python}

Descargar e instalar Anaconda desde \url{https://www.anaconda.com/download}

\begin{lstlisting}[style=bash] 
conda create -n gtsam_env python=<your_python_version>
conda activate gtsam_env
conda install -c conda-forge cmake eigen pybind11 boost numpy matplotlib python-graphviz conda-forge::plotly conda-forge::pandas conda-forge::nbformat
\end{lstlisting}

\begin{lstlisting}[style=bash] 
git clone https://github.com/borglab/gtsam.git
cd gtsam
mkdir build && cd build
conda install -r <gtsam_folder>/python/requirements.txt
cmake .. -DGTSAM_BUILD_PYTHON=1 -DGTSAM_PYTHON_VERSION=<your_python_version>
make -j2 (2 is the number of threads you want to use)
make python-install
\end{lstlisting}

Puede consultar algunos ejemplos de GTSAM en PYTHON en el directorio \url{https://github.com/borglab/gtsam/tree/develop/python/gtsam/examples}.

\section{Graph-SLAM 2D}
\subsection{Lectura de archivos 2D}
\label{sec:read_g2o_2d}
Escriba una función para leer el conjunto de datos \lstinline[style=bash]{input_INTEL_g2o.g2o}\footnote{\url{https://www.dropbox.com/s/vcz8cag7bo0zlaj/input_INTEL_g2o.g2o?dl=0}} desde el formato G2O y generar poses y aristas. Estas poses y aristas se utilizan en problemas posteriores. Pueden estar en cualquier formato que desee siempre que pueda usarlos para generar el resultado correcto.

Para datos 2D, la pose en formato G2O es \lstinline[style=bash]{[VERTEX_SE2 i x y theta]} y la arista en formato G2O es \lstinline[style=bash]{[EDGE_SE2 i j x y theta info(x, y, theta)]}, donde \lstinline[style=bash]{info(x, y, theta)} es un vector $1 \times 6$ \lstinline[style=bash]{[q11 q12 q13 q22 q23 q33]} donde los elementos pertenecen al triángulo superior de la matriz de información $3 \times 3$:

\begin{equation*}
    \Omega = \begin{bmatrix} q_{11} & q_{12} & q_{13} \\ q_{12} & q_{22} & q_{23} \\ q_{13} & q_{23} & q_{33} \end{bmatrix}.
\end{equation*}

Al invertir esta matriz de información, se puede obtener la matriz de covarianza para el modelo de ruido.

Puede verlo en detalle en el repositorio de g2o\footnote{\url{https://github.com/RainerKuemmerle/g2o/wiki/File-Format-SLAM-2D}}.

\textbf{Observación 5.} \textit{Si usa las funciones \lstinline[style=bash]{readG2o()} y \lstinline[style=bash]{load2D()} proporcionadas por GTSAM, entonces no podrá resolver el grafo incrementalmente (tarea~\ref{sec:incremental_solution} en este trabajo práctico).}

\textbf{Sugerencia:} Puede usar funciones \lstinline[style=bash]{fscanf()}, \lstinline[style=bash]{textscan()} o \lstinline[style=bash]{readcell()} con formatSpec adecuado de MATLAB y verificar si el primer elemento en la entrada es \lstinline[style=bash]{VERTEX_SE2} o \lstinline[style=bash]{EDGE_SE2}.

\subsection{Solución por Lotes (Batch Solution)}
Una solución por lotes significa que primero se contruye el grafo completo y luego se lo resuelve por completo. Cargar \lstinline[style=bash]{data/input_INTEL_g2o.g2o} y construir un grafo de factores no lineales 2D usando GTSAM. Utilice el solver de Gauss-Newton. Visualizar y comparar la trayectoria optimizada con la trayectoria inicial. Incluir el plot en el informe. Describir el proceso de construcción del grafo y sus parámetros.

\textbf{Remark 6.} \textit{Para este problema, el solver de Gauss Newton caerá en un mínimo local si no le agregamos una perturbación. Está bien enviar un plot que muestre que no funciona como se espera, pero incluya una discusión sobre por qué sucede esto.}

\textbf{Hint:} Puede usar \lstinline[style=bash]{NonLinearFactorGraph} como grafo, usar \lstinline[style=bash]{GaussNewtonOptimizer} como optimizador, usar \lstinline[style=bash]{Values} para su estimación inicial, \lstinline[style=bash]{noiseModel.Gaussian.Covariance()} para su modelo de ruido, usar las funciones \lstinline[style=bash]{graph.add()} y \lstinline[style=bash]{initial.insert()} cuando lo vea conveniente. Sin embargo, los nombres de las funciones pueden ser diferentes para las diferentes versiones de GTSAM.

\subsection{Solución Incremental}
\label{sec:incremental_solution}
Utilizar el solver ISAM2 para optimizar la trayectoria de forma incremental (a medida que se construye el grafo gradualmente). Un algoritmo detallado se describe en Algoritmo~\ref{alg:isam2}. Visualizar y comparar la trayectoria optimizada con la trayectoria inicial. Incluir el plot en el informe. Describir el proceso de construcción del grafo y sus parámetros.

\begin{algorithm}
    \caption{\lstinline[style=bash]{incremental_solution_2d(poses, edges)}}
    \label{alg:isam2}
    \begin{algorithmic}[1]    
    \Require poses: a N x 4 array that each row is $pose=(id_{p},x,y,\theta)$; edges: a M x 11 array that each row is $edge=(id_{e1},id_{e2},dx,dy,d\theta,info)$
    \State $isam \leftarrow$ gtsam.ISAM2() \Comment{Initialize isam solver}
    \For{every pose in poses}
        \State $graph \leftarrow$ NonlinearFactorGraph \Comment{Initialize the factor graph}
        \State $initialEstimate \leftarrow$ Values \Comment{Initialize the initial estimation}
        \State $(id_{p},x,y,\theta) \gets pose$ \Comment{Extract information from the current pose}
        \If{$id_{p} == 0$}
            \State $priorNoise \leftarrow$ some noiseModel \Comment{Use a predefined noise model}
            \State $graph.add(PriorFactorPose2(0,Pose2(x,y,\theta),priorNoise))$
            \State $initialEstimate.insert(id_{p},\text{Pose2}(x,y,\theta))$
        \Else \Comment{Not the first pose}
            \State $prevPose \gets result.at(id_{p}-1)$ \Comment{Use last optimized pose}
            \State $initialEstimate.insert(id_{p},prevPose)$
        \EndIf
        \For{every edge in edges}
            \State $(id_{e1},id_{e2},dx,dy,d\theta,info) \gets edge$ \Comment{Extract information from the current edge}
            \If{$id_{e2} == id_{p}$}
                \State $cov=construct\_covariance(info)$ \Comment{Construct a covariance matrix from the information vector.}
                \State $Model \leftarrow$ noiseModel.Gaussian.Covariance($cov$)
                \State $graph.add(BetweenFactorPose2(id_{e1},id_{e2},\text{Pose2}(dx,dy,d\theta),Model)$
            \EndIf
        \EndFor
        \State $isam.update(graph,initialEstimate)$
        \State $result=isam.calculateEstimate$
    \EndFor
    \end{algorithmic}
\end{algorithm}

\textbf{Sugerencia:} Puede usar \lstinline[style=bash]{NonLinearFactorGraph} como grafo, usar \lstinline[style=bash]{gtsam.ISAM2()} como algoritmo de actualización, usar \lstinline[style=bash]{Values} para su estimación inicial y usar las funciones \lstinline[style=bash]{graph.add()}, \lstinline[style=bash]{initial.insert()}, \lstinline[style=bash]{isam.update()} y \lstinline[style=bash]{isam.calculateEstimate()} como vea conveniente. Sin embargo, los nombres de las funciones pueden ser diferentes para las diferentes versiones de GTSAM.

\section{Graph-SLAM 3D}
\subsection{Lectura de archivos 3D}
Escriba una función para leer el archivo 3D \lstinline[style=bash]{parking-garage.g2o}\footnote{\url{https://www.dropbox.com/s/zu23p8d522qccor/parking-garage.g2o?dl=0}} desde el formato G2O y genere poses y aristas.

Para datos 3D, una pose en formato G2O es \lstinline[style=bash]{[VERTEX_SE3:QUAT i x y z qx qy qz qw]} donde \lstinline[style=bash]{(x,y,z)} representa la traslación y \lstinline[style=bash]{(qx,qy,qz,qw)} la rotación como un cuaternión. Una arista en formato G2O es \lstinline[style=bash]{[EDGE_SE3:QUAT i j x y z qx qy qz qw info(x, y, z, qx, qy, qz)]}, donde \lstinline[style=bash]{info(x, y, z, qx, qy, qz)} es un vector $1 \times 21$ de la matriz de información $6 \times 6$. Después de un proceso similar en la tarea~\ref{sec:read_g2o_2d}, se puede obtener la matriz de covarianza. Se pueden consultar los detalles en el repositorio de g2o\footnote{\url{https://github.com/RainerKuenmerle/g2o/wiki/File-Format-SLAM-3D}}.

\textbf{Remark 7.} \textit{Tenga en cuenta que el cuaternión en MATLAB está en el orden de \lstinline[style=bash]{[qw qx qy qz]} y es diferente del orden en los archivos g2o que es \lstinline[style=bash]{[qx qy qz qw]}. Puede usar la función \lstinline[style=bash]{quat2rotm()} en MATLAB para construir una matriz de rotación a partir de cuaternión o usar la función \lstinline[style=bash]{quat2tform()} en MATLAB para construir una matriz de transformación.}

\subsection{Solución por Lotes (Batch Solution)}
Cargue \lstinline[style=bash]{data/parking-garage.g2o} y construya un factor-graph 3D no lineal usando GTSAM. Utilice el solver de Gauss-Newton. Visualice y compare la trayectoria optimizada con la trayectoria inicial. Incluya un gráfico 3D o dos gráficos 2D en su pdf. Describir el proceso de construcción del grafo y sus parámetros.

\subsection{Solución Incremental}
Utilice el solver ISAM2 para optimizar la trayectoria de forma incremental. Visualice y compare la trayectoria optimizada con la trayectoria inicial. Incluya un gráfico 3D o dos gráficos 2D en su pdf. Describir el proceso de construcción del grafo y sus parámetros.

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=0.6\textwidth]{images/result_task_1b.png}
    \caption{Expected result for task 1 B.}
    \label{fig:task1b}
\end{figure}

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=0.7\textwidth]{result_task_1c.png}
    \caption{Expected result for task 1 C.}
    \label{fig:task1c}
\end{figure}

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=0.8\textwidth]{result_task_2b.png}
    \caption{Expected result for task 2 B.}
    \label{fig:task2b}
\end{figure}

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=0.8\textwidth]{result_task_2c.png}
    \caption{Expected result for task 2 C.}
    \label{fig:task2c}
\end{figure}

\end{document}